nextflow.enable.dsl = 2

manifest {
  name        = 'germline-nextflow'
  description = 'Lane-aware germline pipeline with optional CNV/SNV/SV callers and BED scatter/gather'
  mainScript  = 'main.nf'
  version     = '1.1.0'
}

params {
  // Required
  genome          = null
  igenomes_base   = 's3://ngi-igenomes/igenomes/'
  igenomes_ignore = false

  // IO
  input  = "${baseDir}/samplesheet.csv"
  outdir = "${baseDir}/results"

  // --------------------------
  // BED / intervals (Case A/B)
  // --------------------------
  intervals    = null
  no_intervals = false

  // Used by CREATE_INTERVALS_BED when BED has no col5
  nucleotides_per_second = 10000000

  // Optional: for better HPC scatter when Case B uses genome intervals:
  // if >0, genome.bed is windowed into fixed-size chunks before CREATE_INTERVALS_BED
  genome_window_bp = 0   // e.g. 20000000 for 20Mb windows

  // Optional shared cache for prepared BEDs (HPC)
  bed_cache_dir = null

  // BED validation / auto-fix
  bed_validate_strict = true
  bed_contig_autofix  = true

  // --------------------------
  // Role BED params (same source by default)
  // Leave as null to fallback to genome.bed (WGS-style) unless you set master_bed
  // --------------------------
  master_bed           = null
  qualimap_feature_bed = null
  coverage_target_bed  = null
  variant_target_bed   = null
  xhmm_intervals_bed   = null

  // DeepVariant special regions/resources
  par_regions_bed       = "${baseDir}/resources/par_regions.bed"
  deepvariant_gzi_dummy = "${baseDir}/resources/dummy_fasta.gzi"

  // --------------------------
  // QC toggles
  // --------------------------
  fastqc_enable      = true
  idxstats_enable    = true
  qualimap_enable    = true
  verifybamid2_enable = true

  // --------------------------
  // Coverage/CNV toggles
  // --------------------------
  depthofcoverage_enable = true

  // XHMM (leave extreme_gc untouched)
  xhmm_enable = true
  xhmm_prefix = 'DATA'
  xhmm_param_file = "${baseDir}/resources/xhmm/params.txt"
  xhmm_extreme_gc_targets = null

  // --------------------------
  // Variant calling toggles
  // --------------------------
  deepvariant_enable        = false
  strelka_enable            = true
  manta_enable              = true

  combine_dv_strelka_enable = false
  norm_combined_enable      = true
  norm_dv_only_enable       = true

  strict_variant_requirements = true

  // --------------------------
  // Tool resources
  // --------------------------
  gatk_gene_list = "${baseDir}/resources/refGene.hg38.refseq"

  manta_config = "${baseDir}/resources/manta/manta_germline.ini"

  verifybamid2_ud  = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.UD"
  verifybamid2_mu  = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.mu"
  verifybamid2_bed = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.bed"
  verifybamid2_dummy_refvcf = "${baseDir}/resources/verifybamid2/dummy.txt"


    // chunking
  nucleotides_per_second = 10000000
  chunk_target_seconds   = 600
  chunk_longest_factor   = 1.05

  // intervals fallback windowing (Case B)
  genome_window_bp = 0                 // e.g. 20000000 for 20 Mb windows

  // contig validation/autofix
  bed_validate_strict = true
  bed_contig_autofix  = true

  genome_window_bp = 20000000   // 20 Mb windows for Case B (built-from-FAI intervals)
  // genome_window_bp = 0       // disable windowing (one interval per contig)

  // optional: exclude contigs when building genome intervals
  build_intervals_exclude_regex = ''   // example: '^(GL|KI|chrUn|hs37d5)'
  

}

if (!params.igenomes_ignore) {
  includeConfig 'conf/igenomes.config'
}

aws {
  client { anonymous = true }
}

process {
  shell = ['/bin/bash', '-euo', 'pipefail']
  errorStrategy = 'terminate'

  withLabel: process_single {
    cpus = 1
    memory = '2 GB'
  }
  withLabel: process_small {
    cpus = 4
    memory = '8 GB'
  }
  withLabel: process_medium {
    cpus = 8
    memory = '16 GB'
  }

  // -----------------------------------
  // Publishing: keep only FINAL BAMs
  // -----------------------------------
  withName: 'BIOBAMBAM_BAMMARKDUPLICATES2' {
    publishDir = [ path: "${params.outdir}/bam", mode: 'copy' ]
  }
  withName: 'SAMTOOLS_INDEX' {
    publishDir = [ path: "${params.outdir}/bam", mode: 'copy' ]
  }
  withName: 'PICARDLIKE_DUPMETRICS' {
    publishDir = [ path: "${params.outdir}/qc/dup_metrics", mode: 'copy' ]
  }

  // QC publishing (small outputs)
  withName: 'FASTQC' {
    publishDir = [ path: "${params.outdir}/qc/fastqc", mode: 'copy' ]
  }
  withName: 'SAMTOOLS_IDXSTATS' {
    publishDir = [ path: "${params.outdir}/qc/idxstats", mode: 'copy' ]
  }
  withName: 'QUALIMAP_BAMQC' {
    publishDir = [ path: "${params.outdir}/qc/qualimap", mode: 'copy' ]
  }
  withName: 'VERIFYBAMID_VERIFYBAMID2' {
    publishDir = [ path: "${params.outdir}/qc/verifybamid2", mode: 'copy' ]
    errorStrategy = 'ignore'
    maxRetries = 1
  }

  // Coverage/CNV
  withName: 'GATK_DEPTHOFCOVERAGE' {
    publishDir = [ path: "${params.outdir}/depthofcoverage", mode: 'copy' ]
  }
  withName: 'GATK_ANNOTATEINTERVALS' {
    publishDir = [ path: "${params.outdir}/xhmm", mode: 'copy' ]
  }
  withName: 'XHMM_PIPELINE' {
    publishDir = [ path: "${params.outdir}/xhmm", mode: 'copy' ]
  }

  // Variant call outputs (final)
  withName: 'GATHER_DEEPVARIANT_VCFS' {
    publishDir = [ path: "${params.outdir}/deepvariant", mode: 'copy' ]
  }
  withName: 'STRELKA_GERMLINE' {
    publishDir = [ path: "${params.outdir}/strelka", mode: 'copy' ]
  }
  withName: 'STRELKA_CHRM_FILTER' {
    publishDir = [ path: "${params.outdir}/strelka_filtered", mode: 'copy' ]
  }
  withName: 'BCFTOOLS_CONCAT_VCF' {
    publishDir = [ path: "${params.outdir}/variants/combined_raw", mode: 'copy' ]
  }
  withName: 'BCFTOOLS_NORM_COMBINED' {
    publishDir = [ path: "${params.outdir}/variants/normalized/combined", mode: 'copy' ]
  }
  withName: 'BCFTOOLS_NORM_DVONLY' {
    publishDir = [ path: "${params.outdir}/variants/normalized/deepvariant_only", mode: 'copy' ]
  }
  withName: 'MANTA_GERMLINE' {
    publishDir = [
      path: "${params.outdir}/manta",
      mode: 'copy',
      saveAs: { filename -> "${task.tag}/${filename}" }
    ]
  }

  // Resource tuning examples (adjust on HPC)
  withName: 'BWA_MEM' {
    cpus = 16
    memory = '24 GB'
  }
  withName: 'DEEPVARIANT_RUNDEEPVARIANT' {
    cpus = 16
    memory = '24 GB'
  }
}

profiles {
  standard {
    process.executor = 'local'
    docker.enabled   = false
    singularity.enabled = false
  }

  docker {
    process.executor  = 'local'
    docker.enabled    = true
    docker.runOptions = '-u $(id -u):$(id -g)'
    docker.registry = 'quay.io'
  }

  singularity {
    docker.enabled         = false
    singularity.enabled    = true
    singularity.autoMounts = true
  }

  slurm {
    process.executor       = 'slurm'
    docker.enabled         = false
    singularity.enabled    = true
    singularity.autoMounts = true
  }
}