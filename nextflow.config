nextflow.enable.dsl = 2

manifest {
    name        = 'germline-nextflow'
    description = 'Small custom pipeline for germline SNP work (reference prep + alignment)'
    author      = 'Viktorija DauksaitÄ—'
    mainScript  = 'main.nf'
    version     = '0.1.0'
}

params {
    // Where final outputs should go
    outdir   = "${baseDir}/results"
    // Where reference + indices will live
    ref_dir  = "${params.outdir}/ref/hg38"

    // Reference FASTA
    ref_name = 'Homo_sapiens_assembly38'
    ref_url  = 'https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/Homo_sapiens_assembly38.fasta'

    // Simple label for the reference
    ref_id   = 'GRCh38'

    // Samplesheet with:
    // patient,sample,lane,fastq_1,fastq_2
    input    = "${baseDir}/samplesheet.csv"
}

process {

    // BWA-MEM alignment
    withName: 'BWA_MEM' {
        cpus   = 16
        memory = '12.GB'
        publishDir = [
            path: "${params.outdir}/alignment",
            mode: 'copy'
        ]
    }

    // AddOrReplaceReadGroups (custom process)
    withName: 'ADD_READGROUPS' {
        cpus   = 4
        memory = '4.GB'
        container = 'community.wave.seqera.io/library/picard:3.4.0--e9963040df0a9bf6'
        publishDir = [
            path: "${params.outdir}/bam_with_rg",
            mode: 'copy'
        ]
    }

    // Picard MarkDuplicates
    withName: 'PICARD_MARKDUPLICATES' {
        cpus      = 8
        memory    = '8.GB'
        ext.args  = '--CREATE_INDEX true'
        publishDir = [
            path: "${params.outdir}/bam",
            mode: 'copy'
        ]
    }

    // New: Picard-like duplication metrics post-processing
    withName: 'PICARDLIKE_DUPMETRICS' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [
            path: "${params.outdir}/dup_metrics_picard_like",
            mode: 'copy'
        ]
    }

    // BWA index: put indices next to the FASTA
    withName: 'BWA_INDEX' {
        cpus   = 16
        memory = '16.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    // Picard sequence dictionary
    withName: 'PICARD_CREATESEQUENCEDICTIONARY' {
        cpus   = 8
        memory = '8.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    // Simple samtools faidx wrapper
    withName: 'SAMTOOLS_FAIDX_SIMPLE' {
        cpus   = 8
        memory = '8.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }
}

profiles {

    standard {
        process.executor = 'local'
        docker.enabled   = false
    }

    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
}
