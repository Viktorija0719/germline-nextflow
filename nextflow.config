nextflow.enable.dsl = 2

manifest {
    name        = 'germline-nextflow'
    description = 'Custom germline SNP mini-pipeline using nf-core modules + VerifyBamID2 + custom dup metrics'
    author      = 'Viktorija Dauksaitė'
    mainScript  = 'main.nf'
    version     = '0.6.0'
}

params {
    // Where final outputs should go
    outdir  = "${baseDir}/results"

    // Where reference + indices will live
    ref_dir = "${baseDir}/results/ref/hg38"

    // Reference FASTA (Broad hg38)
    ref_name = 'Homo_sapiens_assembly38'
    ref_url  = 'https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/Homo_sapiens_assembly38.fasta'

    // Simple label for the reference
    ref_id   = 'GRCh38'

    // Samplesheet with:
    // patient,sample,lane,fastq_1,fastq_2
    input    = "${baseDir}/samplesheet.csv"

    // ---------- VerifyBamID2 resources ----------
    verifybamid2_ud  = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.UD"
    verifybamid2_mu  = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.mu"
    verifybamid2_bed = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.bed"

    // Dummy placeholder file used only to satisfy "path refvcf" input
    // It MUST exist and have a unique name (not UD/MU/BED, not the FASTA).
    verifybamid2_dummy_refvcf = "${baseDir}/resources/verifybamid2/dummy.txt"
}

process {

    // ------------------
    // Reference prep
    // ------------------

    withName: 'DOWNLOAD_REFERENCE' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    withName: 'BWA_INDEX' {
        cpus   = 8
        memory = '16.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    withName: 'PICARD_CREATESEQUENCEDICTIONARY' {
        cpus   = 4
        memory = '4.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    withName: 'SAMTOOLS_FAIDX_SIMPLE' {
        cpus   = 2
        memory = '2.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }


    // ------------------
    // Alignment + RG + dups
    // ------------------

    withName: 'BWA_MEM' {
        cpus   = 16
        memory = '16.GB'
        // Same behaviour as your original script:
        //   -K 100000000 -Y
        ext.args  = '-K 100000000 -Y'
        ext.args2 = ''
        publishDir = [
            path: "${params.outdir}/alignment",
            mode: 'copy'
        ]
    }

    withName: 'ADD_READGROUPS' {
        cpus   = 4
        memory = '4.GB'
        container = 'community.wave.seqera.io/library/picard:3.4.0--e9963040df0a9bf6'
        publishDir = [
            path: "${params.outdir}/bam_with_rg",
            mode: 'copy'
        ]
    }

    withName: 'BIOBAMBAM_BAMMARKDUPLICATES2' {
        cpus   = 8
        memory = '8.GB'
        publishDir = [
            path: "${params.outdir}/bam",
            mode: 'copy'
        ]
    }

    withName: 'SAMTOOLS_INDEX' {
        cpus   = 4
        memory = '4.GB'
        publishDir = [
            path: "${params.outdir}/bam",
            mode: 'copy'
        ]
    }

    withName: 'PICARDLIKE_DUPMETRICS' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [
            path: "${params.outdir}/dup_metrics_picard_like",
            mode: 'copy'
        ]
    }


    // ------------------
    // Alignment QC
    // ------------------

    withName: 'FASTQC' {
        cpus   = 4
        memory = '4.GB'
        // BAM-mode FastQC:
        //   -t 4 --extract -k 7 -f bam --nogroup
        ext.args = '--nogroup -k 7 -f bam --extract'
        publishDir = [
            path: "${params.outdir}/qc/fastqc",
            mode: 'copy'
        ]
    }

    withName: 'SAMTOOLS_IDXSTATS' {
        cpus   = 4
        memory = '2.GB'
        publishDir = [
            path: "${params.outdir}/qc/idxstats",
            mode: 'copy'
        ]
    }

    // ------------------
    // VerifyBamID2 QC
    // ------------------

    withName: 'VERIFYBAMID_VERIFYBAMID2' {
        cpus   = 4
        memory = '8.GB'

        // Your chosen options
        ext.args = '--WithinAncestry --no-orphans --max-depth 1000'

        // VERY IMPORTANT: don't kill the whole workflow if VerifyBamID2 exits with 1
        errorStrategy = 'ignore'
        maxRetries    = 1

        publishDir = [
            path: "${params.outdir}/qc/verifybamid2",
            mode: 'copy'
        ]
    }

}

profiles {

    // Local, no containers (expects everything on PATH)
    standard {
        process.executor = 'local'
        docker.enabled   = false
    }

    // Docker profile – nf-core modules use their own biocontainers/quay images
    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'

        // For images defined as "biocontainers/..." in modules:
        docker.registry   = 'quay.io'
    }
}
