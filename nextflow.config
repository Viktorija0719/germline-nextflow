nextflow.enable.dsl = 2

manifest {
    name        = 'germline-nextflow'
    description = 'Custom germline SNP mini-pipeline using nf-core modules'
    author      = 'Viktorija Dauksaitė'
    mainScript  = 'main.nf'
    version     = '0.7.0'
}

params {
    // ------------------
    // Paths & references
    // ------------------

    genome         = null                          // e.g. 'GATK.GRCh38'
    igenomes_base  = 's3://ngi-igenomes/igenomes/' // or a local mirror path on HPC
    igenomes_ignore = false


    // Samplesheet:
    // patient,sample,lane,fastq_1,fastq_2
    input    = "${baseDir}/samplesheet.csv"
    outdir = "${baseDir}/results"

    // ------------------
    // VerifyBamID2
    // ------------------
    verifybamid2_ud  = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.UD"
    verifybamid2_mu  = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.mu"
    verifybamid2_bed = "${baseDir}/resources/verifybamid2/1000g.phase3.100k.b38.vcf.gz.dat.bed"

    // Dummy placeholder file used only to satisfy "path refvcf" input
    verifybamid2_dummy_refvcf = "${baseDir}/resources/verifybamid2/dummy.txt"


    // ------------------
    // QC BEDs for Qualimap + DepthOfCoverage
    // ------------------

    // If null: pipeline auto-creates whole-genome BED from FASTA .fai for Qualimap
    // If set on CLI: --qualimap_bed /path/to/targets.bed
    qualimap_bed = null

    // Default BED for DepthOfCoverage (can override via --gatk_target_bed)
    gatk_target_bed = "${baseDir}/resources/gencode_v49_protein_coding_exons.bed"

    // Default gene list for DepthOfCoverage (override via --gatk_gene_list)
    gatk_gene_list  = "${baseDir}/resources/refGene.hg38.refseq"

    // ---------- DeepVariant ----------
    // Default intervals for DeepVariant (can re-use WES targets)
    target_regions_bed = "${baseDir}/resources/gencode_v49_protein_coding_exons.bed"
    // Optional PAR regions BED (can be empty)
    par_regions_bed       = "${baseDir}/resources/par_regions.bed"
        // Dummy .gzi file for DeepVariant (to satisfy module input)
    deepvariant_gzi_dummy = "${baseDir}/resources/dummy_fasta.gzi"


    // ------------------
    // Manta germline SV/CNV
    // ------------------
    // Provide a config file for Manta (ini-style).
    // Example path: "${baseDir}/resources/manta/manta_germline.ini"
    manta_config = "${baseDir}/resources/manta/manta_germline.ini"

    // ------------------
    // XHMM
    // ------------------

    xhmm_enable = true

    // Used as the output prefix (DATA.*) and cohort meta.id
    xhmm_prefix = 'DATA'

    // Required: XHMM discovery parameters file
    xhmm_param_file = "${baseDir}/resources/xhmm/params.txt"

    // Intervals used for GC annotation (AnnotateIntervals)
    // Default: reuse the same targets you use for WES calling
    xhmm_intervals = "${params.target_regions_bed}"

    // Optional: if you already have this, set it and pipeline skips AnnotateIntervals
    xhmm_extreme_gc_targets = null

}


// Load mapping of genome keys -> file paths
if ( !params.igenomes_ignore ) {
  includeConfig 'conf/igenomes.config'
}


process {

    // ------------------
    // Reference prep
    // ------------------

    withName: 'DOWNLOAD_REFERENCE' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [ path: "${params.outdir}/ref", mode: 'copy' ]
    }

    withName: 'BWA_INDEX' {
        cpus   = 8
        memory = '16.GB'
        publishDir = [ path: "${params.outdir}/ref", mode: 'copy' ]
    }

    withName: 'PICARD_CREATESEQUENCEDICTIONARY' {
        cpus   = 16
        memory = '12.GB'
        publishDir = [ path: "${params.outdir}/ref", mode: 'copy' ]
    }

    withName: 'SAMTOOLS_FAIDX_SIMPLE' {
        cpus   = 2
        memory = '2.GB'
        publishDir = [ path: "${params.outdir}/ref", mode: 'copy' ]
    }

    withName: 'MAKE_GENOME_BED' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [ path: "${params.outdir}/ref", mode: 'copy' ]
    }


    // ------------------
    // Alignment + RG + dups
    // ------------------

    withName: 'BWA_MEM' {
        cpus   = 16
        memory = '16.GB'
        ext.args  = '-K 100000000 -Y'
        ext.args2 = ''
        publishDir = [ path: "${params.outdir}/alignment", mode: 'copy' ]
    }

    withName: 'ADD_READGROUPS' {
        cpus   = 4
        memory = '4.GB'
        container = 'community.wave.seqera.io/library/picard:3.4.0--e9963040df0a9bf6'
        publishDir = [ path: "${params.outdir}/bam_with_rg", mode: 'copy' ]
    }

    withName: 'BIOBAMBAM_BAMMARKDUPLICATES2' {
        cpus   = 8
        memory = '8.GB'
        publishDir = [ path: "${params.outdir}/bam", mode: 'copy' ]
    }

    withName: 'SAMTOOLS_INDEX' {
        cpus   = 4
        memory = '4.GB'
        publishDir = [ path: "${params.outdir}/bam", mode: 'copy' ]
    }

    withName: 'PICARDLIKE_DUPMETRICS' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [ path: "${params.outdir}/dup_metrics_picard_like", mode: 'copy' ]
    }


    // ------------------
    // Alignment QC
    // ------------------

    withName: 'FASTQC' {
        cpus   = 4
        memory = '4.GB'
        ext.args = '--nogroup -k 7 -f bam --extract'
        publishDir = [ path: "${params.outdir}/qc/fastqc", mode: 'copy' ]
    }

    withName: 'SAMTOOLS_IDXSTATS' {
        cpus   = 4
        memory = '2.GB'
        publishDir = [ path: "${params.outdir}/qc/idxstats", mode: 'copy' ]
    }

    withName: 'QUALIMAP_BAMQC' {
        cpus   = 4
        memory = '8.GB'
        publishDir = [ path: "${params.outdir}/qc/qualimap", mode: 'copy' ]
    }


    // ------------------
    // VerifyBamID2 QC
    // ------------------

    withName: 'VERIFYBAMID_VERIFYBAMID2' {
        cpus   = 4
        memory = '8.GB'
        ext.args = '--WithinAncestry --no-orphans --max-depth 1000'
        errorStrategy = 'ignore'
        maxRetries    = 1
        publishDir = [ path: "${params.outdir}/qc/verifybamid2", mode: 'copy' ]
    }

    // ------------------
    // DepthOfCoverage
    // ------------------

    withName: 'GATK_DEPTHOFCOVERAGE' {
        cpus   = 4
        memory = '8.GB'
        publishDir = [
            path : "${params.outdir}/depthofcoverage",
            mode : 'copy'
        ]
    }


    withName: 'DEEPVARIANT_RUNDEEPVARIANT' {
        // How many shards you want. DeepVariant uses --num_shards=${task.cpus}
        cpus   = 16        // or 32/64 on HPC
        memory = '16.GB'   // adjust for your machine

        // Your requested options
        ext.args = '--model_type=WES --postprocess_variants_extra_args=only_keep_pass=true'

        publishDir = [
            path: "${params.outdir}/deepvariant",
            mode: 'copy'
        ]
    }

    withName: 'STRELKA_GERMLINE' {
        cpus   = 8          // matches `-j 8` in your example
        memory = '13.GB'    // approx. `-g 13`

        // Equivalent of: --exome --callContinuousVf chrM
        ext.args = '--exome --callContinuousVf chrM'

        publishDir = [
            path: "${params.outdir}/strelka",
            mode: 'copy'
        ]
    }

    withName: 'TABIX_TABIX' {
        cpus   = 1
        memory = '1.GB'
        ext.args = '-p bed'   // tell tabix that we’re indexing a BED
    }

    withName: 'STRELKA_CHRM_FILTER' {
        cpus   = 4
        memory = '4.GB'
        publishDir = [
            path: "${params.outdir}/strelka_filtered",
            mode: 'copy'
        ]
    }

    // ------------------
    // bcftools concat & norm
    // ------------------

    withName: 'BCFTOOLS_CONCAT_VCF' {
        cpus   = 4
        memory = '4.GB'
        ext.args = '-a -D --output-type z --write-index=tbi'
        publishDir = [
            path: "${params.outdir}/variants/combined_raw",
            mode: 'copy'
        ]
    }

    withName: 'BCFTOOLS_NORM_COMBINED' {
        cpus   = 4
        memory = '4.GB'
        ext.args = '-m +any --output-type z --write-index=tbi'
        publishDir = [
            path: "${params.outdir}/variants/normalized/combined",
            mode: 'copy'
        ]
    }

    withName: 'BCFTOOLS_NORM_DVONLY' {
        cpus   = 4
        memory = '4.GB'
        ext.args = '-m +any --output-type z --write-index=tbi'
        publishDir = [
            path: "${params.outdir}/variants/normalized/deepvariant_only",
            mode: 'copy'
        ]
    }



    
    withName: 'MANTA_GERMLINE' {
        cpus   = 8
        memory = '16.GB'
        // For WES:
        ext.args = '--exome'
        publishDir = [
            path: "${params.outdir}/manta",
            mode: 'copy',
            saveAs: { filename ->
                // One folder per sample, like other QC
                "${task.tag}/${filename}"
            }
        ]
    }


    withName: 'GATK_ANNOTATEINTERVALS' {
        cpus   = 2
        memory = '4.GB'
        ext.args = '--interval-merging-rule OVERLAPPING_ONLY'
        publishDir = [ path: "${params.outdir}/xhmm", mode: 'copy' ]
    }

    withName: 'XHMM_PIPELINE' {
        cpus   = 4
        memory = '16.GB'

        // Optional tuning via task.ext.*
        ext.prefix = "${params.xhmm_prefix}"
        ext.gc_low  = '0.1'
        ext.gc_high = '0.9'

        // Optional: you can override these strings later if needed
        ext.merge_args     = ''
        ext.matrix1_args   = ''
        ext.normalize_args = ''
        ext.matrix2_args   = ''
        ext.discover_args  = ''

        publishDir = [ path: "${params.outdir}/xhmm", mode: 'copy' ]
    }



}

// Optional: allow public S3 buckets when using s3:// igenomes_base
aws {
    client {
        anonymous = true
    }
    }



profiles {
    standard {
        process.executor = 'local'
        docker.enabled   = false
    }

    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'
        docker.registry   = 'quay.io'
    }

    singularity {
        process.executor = 'local'     // scheduler config usually comes from an HPC site config
        docker.enabled = false
        singularity.enabled = true
        singularity.autoMounts = true
    }
}
