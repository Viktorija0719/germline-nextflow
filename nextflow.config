nextflow.enable.dsl = 2

manifest {
    name        = 'germline-nextflow'
    description = 'Custom germline SNP mini-pipeline using nf-core modules + custom dup metrics'
    author      = 'Viktorija Dauksaitė'
    mainScript  = 'main.nf'
    version     = '0.3.0'
}

params {
    // Where final outputs should go
    outdir  = "${baseDir}/results"

    // Where reference + indices will live
    ref_dir = "${baseDir}/results/ref/hg38"

    // Reference FASTA (Broad hg38)
    ref_name = 'Homo_sapiens_assembly38'
    ref_url  = 'https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/Homo_sapiens_assembly38.fasta'

    // Simple label for the reference
    ref_id   = 'GRCh38'

    // Samplesheet with:
    // patient,sample,lane,fastq_1,fastq_2
    input    = "${baseDir}/samplesheet.csv"
}

process {

    /* -----------------------------
     * Reference-related processes
     * -----------------------------
     */

    // nf-core BWA_INDEX: place index in ref_dir
    withName: 'BWA_INDEX' {
        cpus = 8
        memory = '16.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    // nf-core PICARD_CREATESEQUENCEDICTIONARY: write .dict to ref_dir
    withName: 'PICARD_CREATESEQUENCEDICTIONARY' {
        cpus   = 4
        memory = '4.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    // Simple samtools faidx wrapper: write .fai to ref_dir
    withName: 'SAMTOOLS_FAIDX_SIMPLE' {
        cpus   = 2
        memory = '2.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }

    // Reference downloader: save FASTA to ref_dir
    withName: 'DOWNLOAD_REFERENCE' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [
            path: "${params.ref_dir}",
            mode: 'copy'
        ]
    }


    /* -----------------------------
     * Alignment + dedup
     * -----------------------------
     */

    // nf-core BWA_MEM: mapping + sorting
    withName: 'BWA_MEM' {
        cpus   = 16
        memory = '32.GB'

        // Extra BWA args: -K 100M, -Y (as in your original script)
        ext.args  = '-K 100000000 -Y'

        // Extra samtools sort args if you want; here we leave empty
        // You could add e.g. "-m 768M" if desired:
        // ext.args2 = '-m 768M'
        ext.args2 = ''

        // Optional: publish pre-dup sorted BAMs for QC
        publishDir = [
            path: "${params.outdir}/bam_predup",
            mode: 'copy'
        ]
    }

    // AddOrReplaceReadGroups (custom process)
    withName: 'ADD_READGROUPS' {
        cpus   = 4
        memory = '4.GB'
        container = 'community.wave.seqera.io/library/picard:3.4.0--e9963040df0a9bf6'
        publishDir = [
            path: "${params.outdir}/bam_with_rg",
            mode: 'copy'
        ]
    }

    // nf-core BIOBAMBAM_BAMMARKDUPLICATES2: remove/mark duplicates
    withName: 'BIOBAMBAM_BAMMARKDUPLICATES2' {
        cpus   = 8
        memory = '8.GB'
        publishDir = [
            path: "${params.outdir}/bam_rmdup",
            mode: 'copy'
        ]
    }

    // nf-core SAMTOOLS_INDEX: index deduplicated BAMs
    withName: 'SAMTOOLS_INDEX' {
        cpus   = 4
        memory = '4.GB'
        publishDir = [
            path: "${params.outdir}/bam_rmdup",
            mode: 'copy'
        ]
    }

    // Picard-like duplication metrics post-processing
    withName: 'PICARDLIKE_DUPMETRICS' {
        cpus   = 1
        memory = '1.GB'
        publishDir = [
            path: "${params.outdir}/dup_metrics_picard_like",
            mode: 'copy'
        ]
    }
}


profiles {

    standard {
        process.executor = 'local'
        docker.enabled   = false
    }

    docker {
        process.executor  = 'local'
        docker.enabled    = true
        docker.runOptions = '-u $(id -u):$(id -g)'

        // ⭐ NEW: pull biocontainers images from Quay, not Docker Hub
        docker.registry   = 'quay.io'
    }
}





















    // // biobambam2 bammarkduplicates
    // withName: 'BAMMARKDUPLICATES' {
    //     cpus   = 16
    //     memory = '16.GB'

    //     // Container with bammarkduplicates
    //     // container = 'quay.io/biocontainers/biobambam:2.0.183--h4ac6f70_4'
    //     container = 'quay.io/biocontainers/biobambam:2.0.185--h85de650_1'
    //     // singularity run https://depot.galaxyproject.org/singularity/biobambam:2.0.185--h85de650_1

    //     publishDir = [
    //         path: "${params.outdir}/bam",
    //         mode: 'copy'
    //     ]
    // }

    // // samtools index for final BAMs
    // withName: 'SAMTOOLS_INDEX_BAM' {
    //     cpus   = 4
    //     memory = '4.GB'

    //     // Same samtools image nf-core uses for faidx
    //     container = 'quay.io/biocontainers/samtools:1.22.1--h96c455f_0'

    //     publishDir = [
    //         path: "${params.outdir}/bam",
    //         mode: 'copy'
    //     ]
    // }









